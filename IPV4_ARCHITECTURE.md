# IPv4 Detection - Data Flow Architecture\n\n## System Flow Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────┐\n│                    MONITORING AGENT (Python)                         │\n│                    monitor-agent.py                                  │\n├─────────────────────────────────────────────────────────────────────┤\n│                                                                       │\n│  1. STARTUP - get_local_ipv4_addresses()                            │\n│     ├─ Windows: ipconfig → \"IPv4 Address: 192.168.1.100\"           │\n│     ├─ Linux: hostname -I → \"192.168.1.100 172.17.0.2\"             │\n│     └─ macOS: ifconfig → \"inet 192.168.1.100\"                      │\n│                                                                       │\n│  2. VALIDATION - is_ipv4(ip)                                        │\n│     ├─ Pattern check: ^(\\d{1,3}\\.){3}\\d{1,3}$                      │\n│     ├─ Octet range: 0-255 for each part                             │\n│     └─ Store in: self.ipv4_addresses set                            │\n│                                                                       │\n│  3. DISPLAY - monitor_loop()                                        │\n│     └─ Output: \"Local IPv4: 192.168.1.100, 172.17.0.2\"             │\n│                                                                       │\n│  4. MONITORING                                                       │\n│     ├─ Scan connections (TCP/UDP)                                   │\n│     ├─ Extract: sourceIp, destIp                                    │\n│     └─ Send to API: /api/monitor/connections                        │\n│                                                                       │\n└─────────────────────────────────────────────────────────────────────┘\n                              ↓\n                        (HTTP POST)\n                              ↓\n┌─────────────────────────────────────────────────────────────────────┐\n│              BACKEND API - NEXT.JS SERVER                           │\n│         /api/monitor/connections (POST)                            │\n├─────────────────────────────────────────────────────────────────────┤\n│                                                                       │\n│  1. RECEIVE CONNECTION DATA                                         │\n│     ├─ sourceIp: \"192.168.1.100\"                                   │\n│     ├─ destIp: \"8.8.8.8\" (Google DNS)                              │\n│     ├─ protocol: \"TCP\"                                              │\n│     └─ Store in: monitoring.ts functions                            │\n│                                                                       │\n│  2. UPDATE DEVICE STATUS                                            │\n│     └─ updateDeviceStatus(userId, 'online')                        │\n│                                                                       │\n└─────────────────────────────────────────────────────────────────────┘\n                              ↓\n                        (DATA STORED)\n                              ↓\n┌─────────────────────────────────────────────────────────────────────┐\n│         DASHBOARD API - GET /api/dashboard/users                    │\n│                    (Filtering Logic)                                │\n├─────────────────────────────────────────────────────────────────────┤\n│                                                                       │\n│  1. RETRIEVE USER DATA                                              │\n│     └─ user.connections[] contains sourceIp, destIp                │\n│                                                                       │\n│  2. FILTER IPv4 ADDRESSES                                           │\n│     ├─ Collect all IPs: [sourceIp, destIp]                         │\n│     ├─ isIPv4(ip) check:                                           │\n│     │  ├─ Pattern: /^(\\d{1,3}\\.){3}\\d{1,3}$/                       │\n│     │  ├─ Each octet: 0 ≤ value ≤ 255                              │\n│     │  └─ Examples:                                                 │\n│     │     ✓ 192.168.1.100                                          │\n│     │     ✓ 10.0.0.50                                              │\n│     │     ✗ 256.1.1.1 (invalid octet)                              │\n│     │     ✗ fe80::1 (IPv6)                                         │\n│     └─ Result: ipv4Addresses = [\"192.168.1.100\", \"10.0.0.50\"]     │\n│                                                                       │\n│  3. FILTER IPv6 ADDRESSES                                           │\n│     ├─ isIPv6(ip) check:                                           │\n│     │  ├─ Contains colon (:)                                        │\n│     │  ├─ Not loopback (::1, 127.x.x.x)                            │\n│     │  └─ Examples:                                                 │\n│     │     ✓ fe80::1                                                 │\n│     │     ✓ 2001:db8::1                                            │\n│     │     ✗ ::1 (loopback)                                         │\n│     └─ Result: ipv6Addresses = [\"fe80::1\", \"2001:db8::1\"]          │\n│                                                                       │\n│  4. RETURN RESPONSE                                                  │\n│     ├─ ipv4Addresses: [ ]                                           │\n│     ├─ ipv6Addresses: [ ]                                           │\n│     └─ uniqueIps: [ ] (backward compatible)                         │\n│                                                                       │\n└─────────────────────────────────────────────────────────────────────┘\n                              ↓\n                        (HTTP GET)\n                              ↓\n┌─────────────────────────────────────────────────────────────────────┐\n│            FRONTEND COMPONENTS - React/TypeScript                    │\n│                   Dashboard.tsx                                      │\n│                   UserTable.tsx                                      │\n├─────────────────────────────────────────────────────────────────────┤\n│                                                                       │\n│  1. RECEIVE JSON DATA                                               │\n│     └─ ipv4Addresses[\"192.168.1.100\", \"10.0.0.50\"]                │\n│     └─ ipv6Addresses[\"fe80::1\", \"2001:db8::1\"]                    │\n│                                                                       │\n│  2. UPDATE INTERFACE                                                │\n│     └─ MonitoredUser interface now includes both arrays             │\n│                                                                       │\n│  3. RENDER TABLE ROWS                                               │\n│     ├─ Column: IPv4 Addresses                                       │\n│     │  └─ Render: Blue badges with addresses                        │\n│     │     └─ Show first 2, count remaining                          │\n│     │        ┌─────────────────┐                                    │\n│     │        │ 192.168.1.100   │ ← Blue background                  │\n│     │        │ 10.0.0.50       │   Blue text                        │\n│     │        │ +1              │   Count overflow                    │\n│     │        └─────────────────┘                                    │\n│     │                                                                │\n│     └─ Column: IPv6 Addresses                                       │\n│        └─ Render: Purple badges with addresses                      │\n│           └─ Truncated (first 10 chars)                             │\n│              ┌──────────────────┐                                   │\n│              │ fe80::1...       │ ← Purple background               │\n│              │ 2001:db8::1...   │   Purple text                     │\n│              │ +2               │   Count overflow                  │\n│              └──────────────────┘                                   │\n│                                                                       │\n│  4. USER INTERACTION                                                │\n│     ├─ Click \"View Details\"                                        │\n│     └─ Show full list of IPv4 and IPv6                             │\n│                                                                       │\n│  5. AUTO-REFRESH                                                    │\n│     └─ Every 5 seconds: fetch new data                             │\n│     └─ Display updates automatically                               │\n│                                                                       │\n└─────────────────────────────────────────────────────────────────────┘\n                              ↑\n                              │\n                    (Display in Browser)\n                              │\n                 http://localhost:3000/dashboard\n```\n\n## Data Structure Flow\n\n### Stage 1: Agent Detection\n```\nSystem IPv4 Addresses (OS-specific detection)\n   ↓\n  {192.168.1.100, 172.17.0.2}\n   ↓\nStored in: self.ipv4_addresses\n   ↓\nDisplayed: \"Local IPv4: 192.168.1.100, 172.17.0.2\"\n```\n\n### Stage 2: Connection Data Extraction\n```\nNetwork Connection Stream\n   ↓\n┌─ sourceIp: 192.168.1.100  ──┐\n├─ destIp: 8.8.8.8            ├─→ Multiple connections\n├─ protocol: TCP               │\n└─ (repeat for each connection)┘\n   ↓\nStored in: user.connections[]\n   ↓\nList: [{sourceIp, destIp}, {sourceIp, destIp}, ...]\n```\n\n### Stage 3: API Filtering\n```\nAll IPs from connections\n{192.168.1.100, 8.8.8.8, fe80::1, 10.0.0.50, 2001:db8::1, ...}\n   ↓\n   ├─→ isIPv4() filter\n   │   └─ Result: {192.168.1.100, 8.8.8.8, 10.0.0.50}\n   │\n   └─→ isIPv6() filter\n       └─ Result: {fe80::1, 2001:db8::1}\n   ↓\nAPI Response: {\n  ipv4Addresses: [...],\n  ipv6Addresses: [...]\n}\n```\n\n### Stage 4: Dashboard Display\n```\nAPI Response JSON\n   ↓\nParse ipv4Addresses array\n   ↓\nRender as blue badges\n   ↓\nUser sees: 192.168.1.100  10.0.0.50  +1\n         └─ Blue badges ─┘\n   \nParse ipv6Addresses array\n   ↓\nRender as purple badges\n   ↓\nUser sees: fe80::1...  2001:db8::1...  +2\n         └─ Purple badges ─┘\n```\n\n## Component Interaction\n\n```\nAgent      →  Register Device  →  Backend Database\n   ↓                                    ↓\nScan IPs   →  Send Connections  →  Store Connections\n   ↓                                    ↓\nDisplay    →  User Requests     →  Filter IPv4/IPv6\nIPv4          Dashboard Users        Filter by Type\n   ↓                ↓                    ↓\n[Log]         [Browser]           [API Response]\n            (5-sec refresh)       (with ipv4/ipv6)\n                 ↓\n            [React Component]\n                 ↓\n         [Table with Columns]\n         IPv4 (blue) | IPv6 (purple)\n```\n\n## Data Types Reference\n\n### Agent Side\n```python\nself.ipv4_addresses: Set[str]\n# Example: {'192.168.1.100', '172.17.0.2'}\n\nconnection: Dict\n# Example: {\n#   'sourceIp': '192.168.1.100',\n#   'destIp': '8.8.8.8',\n#   'protocol': 'TCP'\n# }\n```\n\n### API Side\n```typescript\ninterface MonitoredUser {\n  ipv4Addresses: string[];  // ['192.168.1.100', '10.0.0.50']\n  ipv6Addresses: string[];  // ['fe80::1', '2001:db8::1']\n  uniqueIps: string[];      // All addresses combined\n}\n```\n\n### Frontend Side\n```typescript\ninterface MonitoredUser {\n  ipv4Addresses: string[];\n  ipv6Addresses: string[];\n}\n\n// Rendered as:\n{ipv4Addresses.map(ip => <Badge color=\"blue\">{ip}</Badge>)}\n{ipv6Addresses.map(ip => <Badge color=\"purple\">{ip}</Badge>)}\n```\n\n## Timing Sequence\n\n```\nT=0s     Agent starts\n         ├─ Detect IPv4 addresses\n         └─ Display: \"Local IPv4: ...\"\n\nT=0s+    Agent registers device\n         └─ /api/monitor/register\n\nT=10s    Agent scans connections\n         ├─ Get TCP/UDP connections\n         ├─ Extract IPs\n         └─ POST to /api/monitor/connections\n\nT=10s+   Dashboard browser (refreshes every 5s)\n         ├─ GET /api/dashboard/users\n         ├─ Receives ipv4Addresses, ipv6Addresses\n         └─ Renders table with blue/purple badges\n\nT=15s    Dashboard auto-refreshes\n         └─ New data displayed\n\nT=20s    Agent sends more connections (cycle continues)\n```\n\n## Error Handling Flow\n\n```\nIPv4 Detection Error\n   ↓\nTry/Except in get_local_ipv4_addresses()\n   ↓\nSet remains empty\n   ↓\n\"Local IPv4: \" line not shown\n   └─ Agent continues normally\n   └─ No crash\n\nIPv4 Filtering Error\n   ↓\nInvalid IP format\n   ↓\nisIPv4() returns False\n   ↓\nIP excluded from ipv4Addresses\n   ↓\nIncluded in ipv6Addresses (if valid IPv6)\n   └─ Or ignored\n```\n\nThis architecture ensures:\n- ✓ Efficient IPv4 detection\n- ✓ Clean separation of concerns\n- ✓ Real-time updates\n- ✓ Backward compatibility\n- ✓ Error resilience\n"